#include <Arduino.h>
#include <Audio.h>
// Pin Definitions
const int INMP441_DIGITAL_PIN_TOP = 16;   // Digital input pin from INMP441 on top
const int INMP441_DIGITAL_PIN_BOTTOM = 34;   // Digital input pin from INMP441 on bottom
const int POTENTIOMETER_PIN = 18;    // Analog input pin for potentiometer
const int AUDIO_ANALOG_OUT_1 = 40;    // Analog output pin
const int AUDIO_ANALOG_OUT_2 = 41;    // Analog output pin
const int SERIAL_AUDIO_OUT = 24;      // Optional serial audio output pin
const int SET_LEFT = 29;
const int SET_RIGHT = 1;
//const int BUTTON_PIN = 19;
//const int LED_ON_BOARD =13;

// Global Variables
volatile long audioSample = 0;
float gainFactor = 1.0;

void setup() {
  // Initialize Serial Communication
  Serial.begin(50000);
  // Configure INMP441 Digital Input Pin
  pinMode(INMP441_DIGITAL_PIN_TOP, INPUT);
  pinMode(INMP441_DIGITAL_PIN_BOTTOM, INPUT);
  pinMode(SET_RIGHT, OUTPUT);
  pinMode(SET_LEFT, OUTPUT);
  // Configure Potentiometer Pin
  pinMode(POTENTIOMETER_PIN, INPUT);
  
  // Configure Analog Output
  analogWriteResolution(12);  // Teensy 4.1 supports 12-bit analog output
  
  // Optional: Configure Serial Audio Output
  pinMode(SERIAL_AUDIO_OUT, OUTPUT);
}

void loop() {
  digitalWrite(SET_RIGHT, HIGH);
  digitalWrite(SET_LEFT, LOW);
// Read the microphone input
    // Check if any data has been sent to the serial port
  if (Serial.available() > 0) {
      // Read the incoming byte
      char incomingByte = Serial.read();
  int micInput1 = digitalRead(INMP441_DIGITAL_PIN_TOP);
  int micInput2 = digitalRead(INMP441_DIGITAL_PIN_BOTTOM);
  
  // Read potentiometer to adjust gain
  int potValue = analogRead(POTENTIOMETER_PIN);
  
  // Map potentiometer value to gain factor (0.1 to 2.0)
  gainFactor = map(potValue, 0, 1023, 10, 200) / 100.0;
  
  // Apply gain to the microphone inputs
  long processedAudio1 = micInput1 * gainFactor;
  long processedAudio2 = micInput2 * gainFactor;
  
  // Constrain to prevent overflow
  processedAudio1 = constrain(processedAudio1, -2048, 2047);
  processedAudio2 = constrain(processedAudio2, -2048, 2047);
  
  // Output to analog pins (12-bit resolution)
  analogWrite(AUDIO_ANALOG_OUT_1, processedAudio1 + 2048);
  analogWrite(AUDIO_ANALOG_OUT_2, processedAudio2 + 2048);
  
  // Output to serial (for monitoring or external processing)
  Serial.print("Mic1: ");
  Serial.print(processedAudio1);
  Serial.print(" Mic2: ");
  Serial.println(processedAudio2);
  
  // Small delay to prevent overwhelming the system
  delay(10);